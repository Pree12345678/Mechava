<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mechava - Car Invoice App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <!-- Warning: cdn.tailwindcss.com is used here for convenience in development. For production, install Tailwind CSS locally as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
    .modal-bg {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-blue-700 text-white p-4 shadow flex justify-between items-center">
    <h1 class="text-xl font-bold">Mechava</h1>
    <div>
        <button id="homeBtn" class="bg-blue-600 text-white px-4 py-2 rounded mr-2 hover:bg-blue-700 transition">Home</button>    </div>
  </header>

  <main class="flex-grow container mx-auto p-4">
    <!-- User Page -->
    <section id="userPage" class="space-y-6">
      <form id="invoiceForm" class="bg-white p-6 rounded shadow max-w-3xl mx-auto space-y-4">
        <h2 class="text-2xl font-semibold mb-4">Enter Trip Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="date" class="block font-medium mb-1">Date</label>
            <input type="date" id="date" name="date" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="tripSheetNo" class="block font-medium mb-1">Trip Sheet No.</label>
            <input type="text" id="tripSheetNo" name="tripSheetNo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="vehicleNo" class="block font-medium mb-1">Vehicle No.</label>
            <input type="text" id="vehicleNo" name="vehicleNo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="openingKm" class="block font-medium mb-1">Opening KM</label>
            <input type="number" id="openingKm" name="openingKm" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="closingKm" class="block font-medium mb-1">Closing KM</label>
            <input type="number" id="closingKm" name="closingKm" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="hoursDay" class="block font-medium mb-1">Hours/Day</label>
            <input type="number" id="hoursDay" name="hoursDay" min="0" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
        </div>
        <div class="flex space-x-4">
          <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded hover:bg-blue-800 transition">Calculate & Add</button>
        </div>
      </form>

      <section class="max-w-5xl mx-auto mt-8">
        <h2 class="text-2xl font-semibold mb-4">Invoice Details</h2>
        <div class="overflow-x-auto bg-white rounded shadow">
          <table class="min-w-full divide-y divide-gray-200" id="invoiceTable">
            <thead class="bg-blue-700 text-white">
              <tr>
                <th class="px-4 py-2 text-left">Sl. No</th>
                <th class="px-4 py-2 text-left">Date</th>
                <th class="px-4 py-2 text-left">Trip Sheet No.</th>
                <th class="px-4 py-2 text-left">Vehicle No.</th>
                <th class="px-4 py-2 text-left">Opening KM</th>
                <th class="px-4 py-2 text-left">Closing KM</th>
                <th class="px-4 py-2 text-left">Hours/Day</th>
                <th class="px-4 py-2 text-left">Hire Charge (Rs.)</th>
                <th class="px-4 py-2 text-left">Action</th>
              </tr>
            </thead>
            <tbody id="invoiceTableBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Admin Page -->
    <section id="adminPage" class="hidden max-w-3xl mx-auto bg-white p-6 rounded shadow space-y-6">
      <h2 class="text-2xl font-semibold mb-4">Admin - Manage Conditions</h2>
      <form id="adminForm" class="space-y-4">
        <div>
          <label for="basicHours" class="block font-medium mb-1">Basic Hours</label>
          <input type="number" id="basicHours" name="basicHours" min="0" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="basicKm" class="block font-medium mb-1">Basic KM</label>
          <input type="number" id="basicKm" name="basicKm" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="basicCharge" class="block font-medium mb-1">Basic Charge (Rs.)</label>
          <input type="number" id="basicCharge" name="basicCharge" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="extraHourRate" class="block font-medium mb-1">Extra Hour Rate (Rs./hour)</label>
          <input type="number" id="extraHourRate" name="extraHourRate" min="0" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="extraKmRate" class="block font-medium mb-1">Extra KM Rate (Rs./km)</label>
          <input type="number" id="extraKmRate" name="extraKmRate" min="0" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded hover:bg-blue-800 transition">Save Conditions</button>
      </form>
    </section>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50">
      <div class="bg-white rounded shadow-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">Edit Invoice</h3>
        <form id="editForm" class="space-y-4">
          <div>
            <label for="editDate" class="block font-medium mb-1">Date</label>
            <input type="date" id="editDate" name="editDate" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="editTripSheetNo" class="block font-medium mb-1">Trip Sheet No.</label>
            <input type="text" id="editTripSheetNo" name="editTripSheetNo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="editVehicleNo" class="block font-medium mb-1">Vehicle No.</label>
            <input type="text" id="editVehicleNo" name="editVehicleNo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="editOpeningKm" class="block font-medium mb-1">Opening KM</label>
            <input type="number" id="editOpeningKm" name="editOpeningKm" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="editClosingKm" class="block font-medium mb-1">Closing KM</label>
            <input type="number" id="editClosingKm" name="editClosingKm" min="0" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label for="editHoursDay" class="block font-medium mb-1">Hours/Day</label>
            <input type="number" id="editHoursDay" name="editHoursDay" min="0" step="0.1" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          <div class="flex justify-end space-x-4">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">Cancel</button>
            <button type="submit" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition">Save</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Default conditions
    const defaultConditions = {
      basicHours: 8,
      basicKm: 80,
      basicCharge: 2000,
      extraHourRate: 115,
      extraKmRate: 15
    };

    // Load conditions from localStorage or use default
    function loadConditions() {
      const cond = localStorage.getItem('mechavaConditions');
      return cond ? JSON.parse(cond) : defaultConditions;
    }

    // Save conditions to localStorage
    function saveConditions(conditions) {
      localStorage.setItem('mechavaConditions', JSON.stringify(conditions));
    }

    // Load invoices from localStorage
    function loadInvoices() {
      const inv = localStorage.getItem('mechavaInvoices');
      return inv ? JSON.parse(inv) : [];
    }

    // Save invoices to localStorage
    function saveInvoices(invoices) {
      localStorage.setItem('mechavaInvoices', JSON.stringify(invoices));
    }

    // Calculate hire charge based on conditions and input
    function calculateHireCharge(openingKm, closingKm, hoursDay, conditions) {
      const distance = closingKm - openingKm;
      if (distance < 0) return 0; // invalid input
      let charge = conditions.basicCharge;
      const extraHours = Math.max(0, hoursDay - conditions.basicHours);
      const extraKms = Math.max(0, distance - conditions.basicKm);
      charge += extraHours * conditions.extraHourRate;
      charge += extraKms * conditions.extraKmRate;
      return charge;
    }

    // Render invoices table
    function renderInvoices() {
        const invoices = loadInvoices();
        const tbody = document.getElementById('invoiceTableBody');
        tbody.innerHTML = ''; // Clear existing rows
        if (invoices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-2 text-center text-gray-500">No invoices found.</td></tr>';
        } else {
          invoices.forEach((inv, index) => {
            const tr = document.createElement('tr');
            tr.classList.add(index % 2 === 0 ? 'bg-white' : 'bg-gray-50');
            tr.innerHTML = `
              <td class="px-4 py-2">${index + 1}</td>
              <td class="px-4 py-2">${inv.date}</td>
              <td class="px-4 py-2">${inv.tripSheetNo}</td>
              <td class="px-4 py-2">${inv.vehicleNo}</td>
              <td class="px-4 py-2">${inv.openingKm}</td>
              <td class="px-4 py-2">${inv.closingKm}</td>
              <td class="px-4 py-2">${inv.hoursDay}</td>
              <td class="px-4 py-2">${inv.hireCharge.toFixed(2)}</td>
              <td class="px-4 py-2 space-x-2 flex">
                <button class="editBtn text-blue-600 hover:underline" data-index="${index}">Edit</button>
                <button class="deleteBtn text-red-600 hover:underline" data-index="${index}">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        attachActionListeners();
        console.log('Rendered invoices:', invoices); // Debug log
      }// Attach edit and delete button listeners
    function attachActionListeners() {
      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = btn.getAttribute('data-index');
          openEditModal(index);
        });
      });
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const index = btn.getAttribute('data-index');
          deleteInvoice(index);
        });
      });
    }

    // Open edit modal and populate fields
    function openEditModal(index) {
      const invoices = loadInvoices();
      const inv = invoices[index];
      if (!inv) return;
      document.getElementById('editDate').value = inv.date;
      document.getElementById('editTripSheetNo').value = inv.tripSheetNo;
      document.getElementById('editVehicleNo').value = inv.vehicleNo;
      document.getElementById('editOpeningKm').value = inv.openingKm;
      document.getElementById('editClosingKm').value = inv.closingKm;
      document.getElementById('editHoursDay').value = inv.hoursDay;
      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editForm').setAttribute('data-index', index);
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
      document.getElementById('editForm').removeAttribute('data-index');
    }

    // Delete invoice by index
    function deleteInvoice(index) {
      if (confirm('Are you sure you want to delete this invoice?')) {
        const invoices = loadInvoices();
        invoices.splice(index, 1);
        saveInvoices(invoices);
        renderInvoices();
      }
    }

    // Show user page and hide admin page
    function showUserPage() {
      document.getElementById('userPage').classList.remove('hidden');
      document.getElementById('adminPage').classList.add('hidden');
    }

    // Show admin page and hide user page
    function showAdminPage() {
      document.getElementById('adminPage').classList.remove('hidden');
      document.getElementById('userPage').classList.add('hidden');
      loadAdminForm();
    }

    // Load admin form with current conditions
    function loadAdminForm() {
      const cond = loadConditions();
      document.getElementById('basicHours').value = cond.basicHours;
      document.getElementById('basicKm').value = cond.basicKm;
      document.getElementById('basicCharge').value = cond.basicCharge;
      document.getElementById('extraHourRate').value = cond.extraHourRate;
      document.getElementById('extraKmRate').value = cond.extraKmRate;
    }

    // Initialize app
    function init() {
      renderInvoices();
      showUserPage();

      // Navigation buttons
    document.getElementById('homeBtn').addEventListener('click', () => {
        window.location.href = 'landing.html'; // Redirects to landing.html
      });

      // Invoice form submit
      const invoiceForm = document.getElementById('invoiceForm');
      if (invoiceForm) {
        invoiceForm.addEventListener('submit', (e) => {
          e.preventDefault(); // Prevent page refresh
          console.log('Form submitted', e); // Debug log to confirm event
          const form = e.target;
          const date = form.date.value;
          const tripSheetNo = form.tripSheetNo.value.trim();
          const vehicleNo = form.vehicleNo.value.trim();
          const openingKm = parseFloat(form.openingKm.value);
          const closingKm = parseFloat(form.closingKm.value);
          const hoursDay = parseFloat(form.hoursDay.value);

          if (closingKm < openingKm) {
            alert('Closing KM cannot be less than Opening KM.');
            return;
          }

          const conditions = loadConditions();
          const hireCharge = calculateHireCharge(openingKm, closingKm, hoursDay, conditions);

          const invoices = loadInvoices();
          invoices.push({ date, tripSheetNo, vehicleNo, openingKm, closingKm, hoursDay, hireCharge });
          saveInvoices(invoices);
          renderInvoices();
          form.reset(); // Reset form after successful addition
          console.log('Invoice added:', { date, tripSheetNo, vehicleNo, openingKm, closingKm, hoursDay, hireCharge }); // Debug log
        });
      } else {
        console.error('Invoice form not found');
      }

      // Admin form submit
      const adminForm = document.getElementById('adminForm');
      if (adminForm) {
        adminForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const form = e.target;
          const newConditions = {
            basicHours: parseFloat(form.basicHours.value),
            basicKm: parseFloat(form.basicKm.value),
            basicCharge: parseFloat(form.basicCharge.value),
            extraHourRate: parseFloat(form.extraHourRate.value),
            extraKmRate: parseFloat(form.extraKmRate.value)
          };
          saveConditions(newConditions);
          alert('Conditions saved successfully.');
          showUserPage();
        });
      } else {
        console.error('Admin form not found');
      }

      // Edit modal cancel button
      document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

      // Edit form submit
      const editForm = document.getElementById('editForm');
      if (editForm) {
        editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const index = e.target.getAttribute('data-index');
          if (index === null) return;
          const invoices = loadInvoices();

          const date = document.getElementById('editDate').value;
          const tripSheetNo = document.getElementById('editTripSheetNo').value.trim();
          const vehicleNo = document.getElementById('editVehicleNo').value.trim();
          const openingKm = parseFloat(document.getElementById('editOpeningKm').value);
          const closingKm = parseFloat(document.getElementById('editClosingKm').value);
          const hoursDay = parseFloat(document.getElementById('editHoursDay').value);

          if (closingKm < openingKm) {
            alert('Closing KM cannot be less than Opening KM.');
            return;
          }

          const conditions = loadConditions();
          const hireCharge = calculateHireCharge(openingKm, closingKm, hoursDay, conditions);

          invoices[index] = { date, tripSheetNo, vehicleNo, openingKm, closingKm, hoursDay, hireCharge };
          saveInvoices(invoices);
          renderInvoices();
          closeEditModal();
        });
      } else {
        console.error('Edit form not found');
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

